<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Contact List Manager</title>
  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Lucide Icons -->
  <script defer src="https://unpkg.com/lucide@0.276.0/dist/umd/lucide.min.js"></script>
  <!-- Alpine.js (defer!) -->
  <script defer src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js"></script>
</head>
<body 
  x-data="contactManager()" 
  x-init="init()" 
  class="bg-gray-50 min-h-screen flex"
>
  <!-- SIDEBAR -->
  <aside class="w-64 bg-white border-r border-gray-200 p-6 hidden md:block">
    <h2 class="text-xl font-semibold text-gray-800 mb-6">Меню</h2>
    <nav class="space-y-2"> 
      <a href="#" @click.prevent="view='lists'" 
         class="flex items-center px-3 py-2 rounded-lg hover:bg-gray-100 transition-colors"
         :class="view==='lists' ? 'bg-gray-100 font-medium' : ''">
        <i data-lucide="list" class="w-5 h-5 mr-3"></i>
        <span>Списки</span>
      </a>
      <a href="#" @click.prevent="view='contacts'" 
         class="flex items-center px-3 py-2 rounded-lg hover:bg-gray-100 transition-colors"
         :class="view==='contacts' ? 'bg-gray-100 font-medium' : ''">
        <i data-lucide="users" class="w-5 h-5 mr-3"></i>
        <span>Контакты</span>
      </a>
      <a href="#" class="flex items-center px-3 py-2 rounded-lg hover:bg-gray-100 transition-colors">
        <i data-lucide="settings" class="w-5 h-5 mr-3"></i>
        <span>Настройки</span>
      </a>
      <a href="#" class="flex items-center px-3 py-2 rounded-lg hover:bg-gray-100 transition-colors">
        <i data-lucide="info" class="w-5 h-5 mr-3"></i>
        <span>О программе</span>
      </a>
    </nav>
  </aside>

  <!-- MAIN CONTENT -->
  <main class="flex-1 p-6 overflow-auto">
    <div class="max-w-7xl mx-auto">
      <!-- LISTS VIEW -->
      <template x-if="view==='lists'">
        <div>
          <div class="flex items-center justify-between mb-8">
            <div>
              <h1 class="text-3xl font-bold text-gray-900">Contact Lists</h1>
              <p class="text-gray-600 mt-1">Manage your email marketing lists</p>
            </div>
            <button @click="showCreateModal = true"
                    class="flex items-center px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors">
              <i data-lucide="plus" class="w-4 h-4 mr-2"></i>
              Create New List
            </button>
          </div>
          <!-- TOOLBAR -->
          <div class="flex items-center space-x-4 mb-6">
            <div class="flex-1 relative">
              <i data-lucide="search" class="absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400 w-4 h-4"></i>
              <input type="text" placeholder="Search lists..." x-model="search"
                     class="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"/>
            </div>
            <div class="relative">
              <i data-lucide="filter" class="absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400 w-4 h-4"></i>
              <select x-model="filterBy"
                      class="pl-10 pr-8 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent appearance-none bg-white">
                <option value="all">All Lists</option>
                <option value="large">Large (500+)</option>
                <option value="small">Small (&lt;500)</option>
                <option value="recent">Recently Updated</option>
              </select>
            </div>
          </div>
          <!-- LISTS GRID -->
          <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
            <template x-for="list in filteredLists()" :key="list.id">
              <div class="bg-white rounded-lg border border-gray-200 p-6 hover:shadow-md transition-shadow">
                <div class="flex items-start justify-between mb-4">
                  <div class="flex-1">
                    <h3 class="text-lg font-semibold text-gray-900 mb-1" x-text="list.name"></h3>
                    <div class="flex items-center text-sm text-gray-600 space-x-4">
                      <span class="flex items-center">
                        <i data-lucide="users" class="w-4 h-4 mr-1"></i>
                        <span x-text="list.total_contacts" style="margin-right: 5px;"></span> contacts
                      </span>
                      <span class="flex items-center">
                        <i data-lucide="calendar" class="w-4 h-4 mr-1"></i>
                        <span x-text="list.updated_at.split('T')[0]"></span>
                      </span>
                    </div>
                  </div>
                  <button @click="showDeleteConfirm = list.id" class="text-gray-400 hover:text-gray-600 p-1">
                    <i data-lucide="more-horizontal" class="w-4 h-4"></i>
                  </button>
                </div>
                <!-- VALIDATION BAR -->
                <div class="mb-4">
                  <div class="flex text-xs text-gray-600 mb-1 justify-between">
                    <span>Valid: <span x-text="list.valid_count"></span></span>
                    <span>Invalid: <span x-text="list.invalid_count"></span></span>
                    <span>Blacklisted: <span x-text="list.blacklisted_count"></span></span>
                  </div>
                  <div class="w-full bg-gray-200 rounded-full h-2 overflow-hidden flex">
                    <div class="bg-green-500" :style="`width: ${list.valid_count/list.total_contacts*100}%`"></div>
                    <div class="bg-red-500"   :style="`width: ${list.invalid_count/list.total_contacts*100}%`"></div>
                    <div class="bg-gray-400"  :style="`width: ${list.blacklisted_count/list.total_contacts*100}%`"></div>
                  </div>
                </div>
                <!-- ACTIONS -->
                <div class="flex items-center space-x-2">
                  <button @click="viewList(list)" class="flex items-center px-3 py-1.5 text-blue-600 hover:bg-blue-50 rounded-md text-sm">
                    <i data-lucide="eye" class="w-4 h-4 mr-1"></i> View
                  </button>
                  <button @click="showDeleteConfirm = list.id" class="flex items-center px-3 py-1.5 text-red-600 hover:bg-red-50 rounded-md text-sm">
                    <i data-lucide="trash-2" class="w-4 h-4 mr-1"></i> Delete
                  </button>
                </div>
              </div>
            </template>
          </div>
          <template x-if="filteredLists().length===0">
            <div class="text-center py-12">
              <i data-lucide="users" class="w-12 h-12 text-gray-400 mx-auto mb-4"></i>
              <h3 class="text-lg font-medium text-gray-900 mb-2">No lists found</h3>
              <p class="text-gray-600">Create your first email list to get started.</p>
            </div>
          </template>
        </div>
      </template>

      <!-- CONTACTS VIEW -->
      <template x-if="view==='contacts'">
        <div>
          <button @click="backToLists()"
                  class="flex items-center text-blue-600 hover:text-blue-700 mb-4">
            <i data-lucide="arrow-left" class="w-4 h-4 mr-2"></i> Back to Lists
          </button>
          <div class="flex items-center justify-between mb-6">
            <div>
              <h1 class="text-2xl font-bold text-gray-900" x-text="selectedList.name"></h1>
              <div class="flex items-center space-x-4 mt-2 text-sm text-gray-600">
                <span class="flex items-center">
                  <i data-lucide="users" class="w-4 h-4 mr-1"></i>
                  <span x-text="selectedList.total_contacts"></span> contacts
                </span>
                <span class="flex items-center">
                  <i data-lucide="calendar" class="w-4 h-4 mr-1"></i>
                  Updated <span x-text="selectedList.updated_at.split('T')[0]"></span>
                </span>
              </div>
            </div>
            <div class="flex space-x-3">
              <button @click="showImportModal=true"
                      class="flex items-center px-4 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50">
                <i data-lucide="upload" class="w-4 h-4 mr-2"></i> Import
              </button>
              <button @click="deleteListContacts()" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                Validate List
              </button>
            </div>
          </div>

          <!-- SUMMARY -->
          <div class="grid grid-cols-3 gap-4 mb-6">
            <template x-for="stat in ['valid','invalid','blacklisted']" :key="stat">
              <div class="bg-white rounded-lg p-4 border border-gray-200 flex items-center">
                <i
                  :data-lucide="stat==='valid'? 'check-circle' : stat==='invalid'? 'x-circle' : 'alert-circle'"
                  class="w-5 h-5 mr-2"
                  :class="stat==='valid'? 'text-green-500' : stat==='invalid'? 'text-red-500' : 'text-gray-500'"
                ></i>
                <div>
                  <p class="text-sm text-gray-600"
                    x-text="stat==='valid'? 'Valid Contacts' : stat==='invalid'? 'Invalid Contacts' : 'Blacklisted'">
                  </p>
                  <p class="text-xl font-semibold text-gray-900"
                    x-text="selectedList[ stat + '_count' ]">
                  </p>
                </div>
              </div>
            </template>
          </div>


          <!-- CONTACTS TABLE -->
          <div class="bg-white rounded-lg border border-gray-200 overflow-hidden">
            <table class="w-full">
              <thead class="bg-gray-50 border-b border-gray-200">
                <tr>
                  <th class="w-12 px-4 py-3">
                    <input type="checkbox" @click="toggleSelectAll()" :checked="allSelected()" class="rounded border-gray-300"/>
                  </th>
                  <th class="text-left px-4 py-3 text-sm font-medium text-gray-700">Email</th>
                  <th class="text-left px-4 py-3 text-sm font-medium text-gray-700">Status</th>
                  <th class="text-left px-4 py-3 text-sm font-medium text-gray-700">Added Date</th>
                  <th class="w-12 px-4 py-3"></th>
                </tr>
              </thead>
              <tbody class="divide-y divide-gray-200">
                <template x-for="contact in paginatedContacts()" :key="contact.id">
                  <tr class="hover:bg-gray-50">
                    <td class="px-4 py-3">
                      <input type="checkbox" :value="contact.id" @click="selectContact(contact.id)"
                             :checked="selectedContacts.includes(contact.id)" class="rounded border-gray-300"/>
                    </td>
                    <td class="px-4 py-3 text-sm text-gray-900" x-text="contact.email"></td>
                    <td class="px-4 py-3">
                      <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium"
                            :class="statusColor(contact.status)">
                        <i :data-lucide="statusIcon(contact.status)" class="w-4 h-4"></i>
                        <span class="ml-1" x-text="contact.status"></span>
                      </span>
                    </td>
                    <td class="px-4 py-3 text-sm text-gray-600" x-text="contact.added_date.split('T')[0]"></td>
                    <td class="px-4 py-3">
                      <button @click="deleteContact(contact.id)" class="text-red-600 hover:text-red-800">
                        <i data-lucide="trash-2" class="w-4 h-4"></i>
                      </button>
                    </td>
                  </tr>
                </template>
              </tbody>
            </table>
          </div>
          <!-- PAGINATION -->
          <div class="flex items-center justify-between mt-6">
            <p class="text-sm text-gray-600">
              Showing <span x-text="startIndex()+1"></span> to <span x-text="endIndex()"></span> of <span x-text="contacts.length"></span> contacts
            </p>
            <div class="flex space-x-2">
              <button @click="prevPage()" :disabled="page===1"
                      class="px-3 py-1 border border-gray-300 rounded text-sm disabled:opacity-50 disabled:cursor-not-allowed hover:bg-gray-50">
                Previous
              </button>
              <template x-for="p in totalPages()" :key="p">
                <button @click="page = p"
                        class="px-3 py-1 border rounded text-sm"
                        :class="page===p? 'bg-blue-600 text-white border-blue-600':'border-gray-300 hover:bg-gray-50'">
                  <span x-text="p"></span>
                </button>
              </template>
              <button @click="nextPage()" :disabled="page===totalPages()"
                      class="px-3 py-1 border border-gray-300 rounded text-sm disabled:opacity-50 disabled:cursor-not-allowed hover:bg-...">
                Next
              </button>
            </div>
          </div>
        </div>
      </template>
    </div>

    <!-- CREATE LIST MODAL -->
    <div x-show="showCreateModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
      <div class="bg-white rounded-lg p-6 w-full max-w-md">
        <h3 class="text-lg font-semibold mb-4">Create New List</h3>
        <div class="space-y-4">
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">List Name</label>
            <input type="text" x-model="newListName" placeholder="Enter list name..."
                   class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" autofocus/>
          </div>
          <div class="flex space-x-3">
            <button @click="showCreateModal=false" class="flex-1 px-4 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50">Cancel</button>
            <button @click="createList()" :disabled="!newListName.trim()"
                    class="flex-1 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 disabled:opacity-50 disabled:cursor-not-allowed">Create List</button>
          </div>
        </div>
      </div>
    </div>

    <div x-show="showDeleteConfirm" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white rounded-lg p-6 w-full max-w-md">
          <h3 class="text-lg font-semibold mb-4">Delete List</h3>
          <p class="text-gray-600 mb-6">Are you sure you want to delete this list? This action cannot be undone.</p>
          <div class="flex space-x-3">
            <button @click="showDeleteConfirm = null" class="flex-1 px-4 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50">Cancel</button>
            <button @click="deleteList()" class="flex-1 px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700">Delete</button>
          </div>
        </div>
    </div>

    <!-- IMPORT MODAL -->
    <div x-show="showImportModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
      <div class="bg-white rounded-lg p-6 w-full max-w-md">
        <h3 class="text-lg font-semibold mb-4">Import Contacts</h3>

        <!-- выбор файла или дроп -->
        <div class="border-2 border-dashed border-gray-300 rounded-lg p-8 text-center"
            @dragover.prevent
            @drop.prevent="handleFileChange($event)">
          <i data-lucide="upload" class="w-8 h-8 text-gray-400 mx-auto mb-2"></i>
          <p class="text-sm text-gray-600 mb-2">Drag & drop your file here, or</p>
          <button @click="$refs.fileInput.click()" class="text-blue-600 hover:text-blue-700 text-sm font-medium">
            Browse files
          </button>
          <input x-ref="fileInput" type="file" accept=".csv,.txt,.json" class="hidden"
                @change="handleFileChange($event)"/>
          <template x-if="importFileObj">
            <p class="mt-2 text-xs text-green-600" x-text="importFileObj.name"></p>
          </template>
        </div>

        <!-- кнопки -->
        <div class="flex space-x-3 mt-4">
          <button
            @click="closeImport()"
            class="flex-1 px-4 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50"
          >
            Cancel
          </button>
          <button
            @click="importFile()"
            :disabled="!importFileObj || isImporting"
            class="flex-1 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 disabled:opacity-50"
          >
            <span x-text="isImporting ? 'Importing…' : 'Import'"></span>
          </button>
        </div>
        

        <!-- успех -->
        <template x-if="importSuccess">
          <p class="mt-4 text-center text-green-600">✔ Contacts imported successfully!</p>
        </template>
      </div>
    </div>


  </main>

  <!-- Alpine + API Script -->
  <script defer>
    const API_BASE = '/mailer/api/contactlists/';
  
    document.addEventListener('alpine:init', () => {
      Alpine.data('contactManager', () => ({
        view: 'lists',
        search: '',
        filterBy: 'all',
        page: 1,
        contactsPerPage: 10,
        lists: [],
        contacts: [],
        selectedList: null,
        showCreateModal: false,
        showDeleteConfirm: null,
        showImportModal: false,
        newListName: '',
        newContactEmail: '',
        selectedContacts: [],
        // импорт
        importFileObj: null,
        isImporting: false,
  
        init() {
          this.initLucide();
          this.fetchLists();
        },
  
        async fetchLists() {
          try {
            const res = await fetch(API_BASE, { credentials: 'same-origin' });
            if (!res.ok) throw new Error(`Status ${res.status}`);
            this.lists = await res.json();
            this.refreshIcons();
          } catch (err) {
            console.error('Error fetching lists:', err);
          }
        },
  
        async createList() {
          if (!this.newListName.trim()) return;
          const res = await fetch(API_BASE, {
            method: 'POST',
            credentials: 'same-origin',
            headers: { 'Content-Type': 'application/json', 'X-CSRFToken': getCSRFToken() },
            body: JSON.stringify({ name: this.newListName })
          });
          if (res.ok) {
            this.newListName = '';
            this.showCreateModal = false;
            await this.fetchLists();
          }
        },
  
        async deleteList() {
          if (!this.showDeleteConfirm) return;
          const url = `${API_BASE}${this.showDeleteConfirm}/`;
          const res = await fetch(url, { method: 'DELETE', credentials: 'same-origin', headers: { 'X-CSRFToken': getCSRFToken() } });
          if (res.ok) {
            this.showDeleteConfirm = null;
            await this.fetchLists();
          }
        },
  
        async viewList(list) {
          this.selectedList = list;
          this.view = 'contacts';
          this.page = 1;
          const url = `${API_BASE}${list.id}/contacts/`;
          const res = await fetch(url, { credentials: 'same-origin' });
          this.contacts = await res.json();
          this.refreshIcons();
        },
  
        backToLists() {
          this.view = 'lists';
          this.selectedList = null;
          this.contacts = [];
          this.fetchLists();
        },
  
        async addContact() {
          const email = this.newContactEmail.trim();
          if (!email) return;
          const url = `${API_BASE}${this.selectedList.id}/contacts/`;
          const res = await fetch(url, {
            method: 'POST',
            credentials: 'same-origin',
            headers: { 'Content-Type': 'application/json', 'X-CSRFToken': getCSRFToken() },
            body: JSON.stringify({ email, status: 'valid' })
          });
          if (res.ok) await this.viewList(this.selectedList);
        },
  
        async deleteContact(id) {
          const url = `${API_BASE}${this.selectedList.id}/contacts/${id}/`;
          const res = await fetch(url, { method: 'DELETE', credentials: 'same-origin', headers: { 'X-CSRFToken': getCSRFToken() } });
          if (res.ok) await this.viewList(this.selectedList);
        },
  
        filteredLists() {
          return this.lists
            .filter(l => l.name.toLowerCase().includes(this.search.toLowerCase()))
            .filter(l => {
              if (this.filterBy === 'large') return l.total_contacts >= 500;
              if (this.filterBy === 'small') return l.total_contacts < 500;
              if (this.filterBy === 'recent') return new Date(l.updated_at) > Date.now() - 7 * 86400000;
              return true;
            });
        },
  
        paginatedContacts() {
          const start = (this.page - 1) * this.contactsPerPage;
          return this.contacts.slice(start, start + this.contactsPerPage);
        },
        totalPages() { return Math.ceil(this.contacts.length / this.contactsPerPage); },
        prevPage() { if (this.page > 1) this.page--; },
        nextPage() { if (this.page < this.totalPages()) this.page++; },
        startIndex() { return (this.page - 1) * this.contactsPerPage; },
        endIndex() { return Math.min(this.page * this.contactsPerPage, this.contacts.length); },
  
        selectContact(id) {
          const i = this.selectedContacts.indexOf(id);
          if (i >= 0) this.selectedContacts.splice(i, 1);
          else this.selectedContacts.push(id);
        },
        allSelected() { return this.selectedContacts.length === this.contacts.length; },
        toggleSelectAll() { this.allSelected() ? this.selectedContacts = [] : this.selectedContacts = this.contacts.map(c => c.id); },
  
        refreshIcons() { setTimeout(() => lucide && lucide.createIcons(), 10); },
        initLucide() { lucide && lucide.createIcons(); },
  
        statusColor(status) { return status === 'valid' ? 'text-green-600 bg-green-50' : status === 'invalid' ? 'text-red-600 bg-red-50' : 'text-gray-600 bg-gray-50'; },
        statusIcon(status) { return status === 'valid' ? 'check-circle' : status === 'invalid' ? 'x-circle' : 'alert-circle'; },
  
        // === импорт ===
        openImport() {
          this.importFileObj = null;
          this.importSuccess = false;
          this.showImportModal = true;
        },
        closeImport() {
          this.showImportModal = false;
        },
        handleFileChange(e) {
          this.importFileObj = e.target.files?.[0] || e.dataTransfer.files?.[0] || null;
        },
        async importFile() {
          if (!this.importFileObj || !this.selectedList) return;
          this.isImporting = true;
          const fd = new FormData();
          fd.append('file', this.importFileObj);

          const res = await fetch(`${API_BASE}${this.selectedList.id}/import/`, {
            method: 'POST',
            credentials: 'same-origin',
            headers: { 'X-CSRFToken': getCSRFToken() },
            body: fd
          });

          if (res.ok) {
            this.importSuccess = true;
            await this.viewList(this.selectedList);
          } else {
            console.error('Import failed', await res.text());
          }
          this.isImporting = false;
        },
      }));
    });
  
    function getCSRFToken() {
      return document.cookie
        .split(';')
        .map(c => c.trim())
        .find(c => c.startsWith('csrftoken='))
        ?.split('=')[1] || '';
    }
  
    function showToast(message, type = 'success') {
      const toast = document.createElement('div');
      toast.textContent = message;
      toast.className = `fixed bottom-5 right-5 px-4 py-2 rounded-lg shadow-lg text-white text-sm z-[9999] ${
        type === 'success' ? 'bg-green-600' : 'bg-red-600'
      }`;
      document.body.appendChild(toast);
      setTimeout(() => toast.remove(), 3000);
    }
  </script>
  
</body>
</html>
