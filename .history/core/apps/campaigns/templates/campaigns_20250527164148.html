<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1.0">
  <title>New Campaign</title>
  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Alpine.js -->
  <script src="https://unpkg.com/alpinejs" defer></script>
  <!-- Lucide Icons -->
  <script src="https://unpkg.com/lucide@latest"></script>
</head>
<body>
  <div class="min-h-screen bg-gray-50 flex" x-data="campaignForm">
    <!-- Sidebar -->
    <div class="w-64 bg-white border-r border-gray-200 flex flex-col">
      <div class="p-6 border-b border-gray-200">
        <h2 class="text-xl font-semibold text-gray-900">Email</h2>
      </div>
      <nav class="flex-1 p-4 space-y-2">
        <!-- ... ваши пункты меню ... -->
        <div class="flex items-center space-x-3 px-3 py-2 rounded-lg bg-blue-50 text-blue-700 border border-blue-200">
          <i data-lucide="mail" class="w-5 h-5"></i>
          <span class="font-medium">Campaigns</span>
        </div>
        <!-- остальное меню по аналогии -->
      </nav>
    </div>

    <!-- Main Content -->
    <div class="flex-1 flex">
      <!-- Form Section -->
      <div class="flex-1 p-8">
        <div class="max-w-2xl mx-auto">
          <!-- Header -->
          <div class="flex items-center justify-between mb-8">
            <div>
              <h1 class="text-3xl font-bold text-gray-900">Новая рассылка</h1>
              <p class="text-gray-600 mt-2">Создайте и отправьте свою email-кампанию</p>
            </div>
            <template x-if="saveStatus">
              <div class="flex items-center space-x-2 text-green-600">
                <i data-lucide="check" class="w-4 h-4"></i>
                <span class="text-sm font-medium" x-text="saveStatus"></span>
              </div>
            </template>
          </div>

          <!-- Form Fields -->
          <div class="space-y-6">
            <!-- Campaign Name -->
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">
                Название рассылки <span class="text-red-500">*</span>
              </label>
              <input
                type="text"
                x-model="formData.campaignName"
                @input.debounce.1000ms="handleSave()"
                :class="errors.campaignName ? 'border-red-300' : 'border-gray-300'"
                class="w-full px-4 py-3 border rounded-lg focus:ring-2 focus:ring-blue-500 transition-colors"
                placeholder="Enter campaign name"
              />
              <template x-if="errors.campaignName">
                <p class="text-red-500 text-sm mt-1" x-text="errors.campaignName"></p>
              </template>
            </div>

            <!-- Template Selection -->
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">
                Выберите шаблон электронной почты
              </label>
              <div class="relative">
                <button
                  type="button"
                  @click="showTemplateDropdown = !showTemplateDropdown"
                  class="w-full px-4 py-3 border border-gray-300 rounded-lg bg-white text-left flex items-center justify-between hover:border-gray-400 transition-colors"
                >
                  <span :class="formData.templateId ? 'text-gray-900' : 'text-gray-500'">
                    <template x-if="formData.templateId">
                      <span x-text="templates.find(t => t.id === formData.templateId).name"></span>
                    </template>
                    <template x-if="!formData.templateId">
                      <span>Выберите шаблон</span>
                    </template>
                  </span>
                  <i data-lucide="chevron-down" class="w-5 h-5 text-gray-400"></i>
                </button>
                <div
                  x-show="showTemplateDropdown"
                  @click.away="showTemplateDropdown = false"
                  class="absolute top-full left-0 right-0 mt-1 bg-white border border-gray-200 rounded-lg shadow-lg z-10"
                >
                  <template x-for="t in templates" :key="t.id">
                    <div
                      @click="formData.templateId = t.id; showTemplateDropdown = false"
                      class="p-4 hover:bg-gray-50 cursor-pointer border-b last:border-b-0"
                    >
                      <div class="font-medium text-gray-900" x-text="t.name"></div>
                      <div class="text-sm text-gray-600 mt-1" x-text="t.preview"></div>
                    </div>
                  </template>
                </div>
              </div>
            </div>

            <!-- Contact Lists -->
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">
                Выберите списки контактов <span class="text-red-500">*</span>
              </label>
              <div class="relative">
                <button
                  type="button"
                  @click="showContactListDropdown = !showContactListDropdown"
                  :class="errors.contactLists ? 'border-red-300' : 'border-gray-300'"
                  class="w-full px-4 py-3 border rounded-lg bg-white text-left flex items-center justify-between hover:border-gray-400 transition-colors"
                >
                  <span :class="formData.contactLists.length ? 'text-gray-900' : 'text-gray-500'">
                    <template x-if="formData.contactLists.length">
                      <span x-text="`${formData.contactLists.length} спис${formData.contactLists.length>1?'ка':'ок'} выбрано`"></span>
                    </template>
                    <template x-if="!formData.contactLists.length">
                      <span>Выберите списки контактов</span>
                    </template>
                  </span>
                  <i data-lucide="chevron-down" class="w-5 h-5 text-gray-400"></i>
                </button>
                <div
                  x-show="showContactListDropdown"
                  @click.away="showContactListDropdown = false"
                  class="absolute top-full left-0 right-0 mt-1 bg-white border border-gray-200 rounded-lg shadow-lg z-10"
                >
                  <template x-for="l in contactLists" :key="l.id">
                    <label class="flex items-center space-x-3 p-3 hover:bg-gray-50 cursor-pointer">
                      <input
                        type="checkbox"
                        class="w-4 h-4"
                        x-model="formData.contactLists"
                        :value="l.id"
                      />
                      <div class="flex-1">
                        <div class="font-medium text-gray-900" x-text="l.name"></div>
                        <div class="text-sm text-gray-500" x-text="`${l.count} контактов`"></div>
                      </div>
                    </label>
                  </template>
                </div>
              </div>
              <template x-if="errors.contactLists">
                <p class="text-red-500 text-sm mt-1" x-text="errors.contactLists"></p>
              </template>
            </div>

            <!-- Sender Email -->
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">
                Электронная почта отправителя <span class="text-red-500">*</span>
              </label>
              <div class="relative">
                <button
                  type="button"
                  @click="showSenderDropdown = !showSenderDropdown"
                  :class="errors.senderEmail ? 'border-red-300' : 'border-gray-300'"
                  class="w-full px-4 py-3 border rounded-lg bg-white text-left flex items-center justify-between hover:border-gray-400 transition-colors"
                >
                  <span :class="formData.senderEmail ? 'text-gray-900' : 'text-gray-500'">
                    <template x-if="formData.senderEmail">
                      <span x-text="formData.senderEmail"></span>
                    </template>
                    <template x-if="!formData.senderEmail">
                      <span>Выберите адрес отправителя</span>
                    </template>
                  </span>
                  <i data-lucide="chevron-down" class="w-5 h-5 text-gray-400"></i>
                </button>
                <div
                  x-show="showSenderDropdown"
                  @click.away="showSenderDropdown = false"
                  class="absolute top-full left-0 right-0 mt-1 bg-white border border-gray-200 rounded-lg shadow-lg z-10"
                >
                  <template x-for="e in senderEmails" :key="e.id">
                    <div
                      @click="formData.senderEmail = e.email; showSenderDropdown = false"
                      class="p-3 hover:bg-gray-50 cursor-pointer flex items-center justify-between"
                    >
                      <span class="text-gray-900" x-text="e.email"></span>
                      <span class="text-green-600 text-sm font-medium">Verified</span>
                    </div>
                  </template>
                </div>
              </div>
              <template x-if="errors.senderEmail">
                <p class="text-red-500 text-sm mt-1" x-text="errors.senderEmail"></p>
              </template>
            </div>

            <!-- Subject -->
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">
                Тема письма <span class="text-red-500">*</span>
              </label>
              <input
                type="text"
                x-model="formData.subject"
                @input.debounce.1000ms="handleSave()"
                :class="errors.subject ? 'border-red-300' : 'border-gray-300'"
                class="w-full px-4 py-3 border rounded-lg focus:ring-2 focus:ring-blue-500 transition-colors"
                placeholder="Enter email subject"
              />
              <template x-if="errors.subject">
                <p class="text-red-500 text-sm mt-1" x-text="errors.subject"></p>
              </template>
            </div>

            <!-- Optional fields: senderName, replyTo, schedule -->
            <!-- ... аналогично выше ... -->

            <!-- Action Buttons -->
            <div class="flex space-x-4 pt-6">
              <button
                @click="sendCampaign()"
                class="flex items-center space-x-2 bg-blue-600 text-white px-6 py-3 rounded-lg hover:bg-blue-700 transition-colors font-medium"
              >
                <i data-lucide="send" class="w-4 h-4"></i>
                <span>Отправить</span>
              </button>
              <button
                @click="alert('Кампания сохранена как черновик')"
                class="flex items-center space-x-2 bg-gray-200 text-gray-700 px-6 py-3 rounded-lg hover:bg-gray-300 transition-colors font-medium"
              >
                <i data-lucide="save" class="w-4 h-4"></i>
                <span>Сохранить как черновик</span>
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- Preview Section -->
      <div class="w-96 bg-white border-l border-gray-200 p-6">
        <!-- ... ваш живой превью ... -->
      </div>
    </div>
  </div>

  <!-- Alpine.js Logic -->
  <script>
    const API_BASE      = '/campaigns/api/';
    const CAMPAIGNS_API = API_BASE + 'campaigns/';
    const TEMPLATES_API = '/templates/api/templates/';
    const LISTS_API     = '/lists/api/contactlists/';
    const SENDERS_API   = '/emails/api/sender-emails/';

    function getCSRF() {
      return document.cookie
        .split(';').map(c => c.trim())
        .find(c => c.startsWith('csrftoken='))
        ?.split('=')[1] || '';
    }

    document.addEventListener('alpine:init', () => {
      Alpine.data('campaignForm', () => ({
        campaign: null,
        formData: {
          id: null,
          campaignName: '',
          templateId: '',
          contactLists: [],
          senderEmail: '',
          subject: '',
          senderName: '',
          replyTo: '',
          scheduledDate: '',
          scheduledTime: ''
        },
        showTemplateDropdown: false,
        showContactListDropdown: false,
        showSenderDropdown: false,
        saveStatus: '',
        errors: {},
        templates: [],
        contactLists: [],
        senderEmails: [],

        init() {
          // загрузка справочников
          Promise.all([
            fetch(TEMPLATES_API).then(r=>r.json()),
            fetch(LISTS_API,     { credentials: 'same-origin' }).then(r=>r.json()),
            fetch(SENDERS_API,   { credentials: 'same-origin' }).then(r=>r.json())
          ]).then(([tpls, lists, snd]) => {
            this.templates = tpls;
            this.contactLists = lists.map(l => ({ id: l.id, name: l.name, count: l.contacts_count }));
            this.senderEmails = snd.filter(e => e.verified);
          });

          // если редактируем (— ?id=)
          const params = new URLSearchParams(window.location.search);
          if (params.has('id')) {
            const id = params.get('id');
            fetch(CAMPAIGNS_API + id + '/', { credentials: 'same-origin' })
              .then(r=>r.json()).then(data => {
                this.campaign = data;
                Object.assign(this.formData, {
                  id: data.id,
                  campaignName: data.name,
                  templateId: data.template,
                  contactLists: data.contact_lists,
                  senderEmail: data.sender_email,
                  subject: data.subject,
                  senderName: data.sender_name,
                  replyTo: data.reply_to,
                  scheduledDate: data.scheduled_date,
                  scheduledTime: data.scheduled_time
                });
              });
          }
        },

        handleSave() {
          if (!this.formData.campaignName && !this.formData.subject) return;
          this.saveStatus = 'Saving…';
          const method = this.formData.id ? 'PUT' : 'POST';
          const url    = this.formData.id ? CAMPAIGNS_API + this.formData.id + '/' : CAMPAIGNS_API;

          fetch(url, {
            method,
            credentials: 'same-origin',
            headers: {
              'Content-Type': 'application/json',
              'X-CSRFToken': getCSRF()
            },
            body: JSON.stringify({
              name:           this.formData.campaignName,
              template:       this.formData.templateId,
              contact_lists:  this.formData.contactLists,
              sender_email:   this.formData.senderEmail,
              subject:        this.formData.subject,
              sender_name:    this.formData.senderName,
              reply_to:       this.formData.replyTo,
              scheduled_date: this.formData.scheduledDate,
              scheduled_time: this.formData.scheduledTime
            })
          })
          .then(async res => {
            if (!res.ok) throw await res.json();
            return res.json();
          })
          .then(data => {
            this.formData.id = data.id;
            this.campaign = data;
            this.saveStatus = 'Saved';
            setTimeout(() => this.saveStatus = '', 2000);
          })
          .catch(err => {
            this.errors = err;
            this.saveStatus = '';
          });
        },

        validateForm() {
          this.errors = {};
          if (!this.formData.campaignName) this.errors.campaignName = 'Обязательно';
          if (!this.formData.subject)      this.errors.subject = 'Обязательно';
          if (!this.formData.senderEmail)  this.errors.senderEmail = 'Обязательно';
          if (!this.formData.contactLists.length) this.errors.contactLists = 'Выберите хотя бы один список';
          return !Object.keys(this.errors).length;
        },

        sendCampaign() {
          if (!this.validateForm()) return;
          fetch(CAMPAIGNS_API + this.formData.id + '/send/', {
            method: 'POST',
            credentials: 'same-origin',
            headers: { 'X-CSRFToken': getCSRF() }
          })
          .then(r => {
            if (!r.ok) throw r;
            alert('Кампания запущена!');
          })
          .catch(() => alert('Ошибка при отправке'));
        }
      }));
    });

    document.addEventListener('alpine:initialized', () => lucide.createIcons());
    document.addEventListener('alpine:updated',     () => lucide.createIcons());
  </script>
</body>
</html>
