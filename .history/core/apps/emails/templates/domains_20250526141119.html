<script>
    const API_BASE = '/emails/domains/api/domains/';
  
    // Хелпер для CSRF
    function getCSRFToken() {
      return document.cookie
        .split(';')
        .map(c => c.trim())
        .find(c => c.startsWith('csrftoken='))
        ?.split('=')[1] || '';
    }
  
    document.addEventListener('alpine:init', () => {
      Alpine.data('emailPlatform', () => ({
        activeSection: 'domains',
        showAddDomainModal: false,
        showDnsInstructions: null,
        domains: [],
        newDomain: '',
        notification: null,
        isChecking: {},
  
        init() {
          this.loadDomains();
        },
  
        // Загрузить все домены из API
        async loadDomains() {
          try {
            const res = await fetch(API_BASE, { credentials: 'same-origin' });
            if (!res.ok) throw new Error('Не удалось загрузить домены');
            const data = await res.json();
            // приводим к формату, который ожидает шаблон
            this.domains = data.map(d => ({
              id: d.id,
              name: d.domain_name,
              spf: d.spf_verified,
              dkim: d.dkim_verified,
              verified: d.is_verified,
              addedDate: d.created_at.split('T')[0],
              token: d.verification_token
            }));
            // инициализируем флаги isChecking
            this.domains.forEach(d => this.isChecking[d.id] = false);
          } catch (e) {
            this.showNotification(e.message, 'error');
          }
        },
  
        // Добавить новый домен
        async handleAddDomain() {
          if (!this.newDomain.trim()) return;
          try {
            const res = await fetch(API_BASE, {
              method: 'POST',
              credentials: 'same-origin',
              headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCSRFToken(),
              },
              body: JSON.stringify({ domain_name: this.newDomain.trim() })
            });
            if (!res.ok) {
              const err = await res.json();
              throw new Error(err.detail || 'Ошибка при создании домена');
            }
            const d = await res.json();
            this.newDomain = '';
            this.showAddDomainModal = false;
            this.showDnsInstructions = d.id;
            this.showNotification('Домен создан, настройте DNS записи.');
            // сразу дозагрузить список
            await this.loadDomains();
          } catch (e) {
            this.showNotification(e.message, 'error');
          }
        },
  
        // Удалить домен
        async deleteDomain(id) {
          if (!confirm('Удалить этот домен?')) return;
          try {
            const res = await fetch(`${API_BASE}${id}/`, {
              method: 'DELETE',
              credentials: 'same-origin',
              headers: { 'X-CSRFToken': getCSRFToken() }
            });
            if (!res.ok) throw new Error('Не удалось удалить домен');
            this.showNotification('Домен удалён');
            await this.loadDomains();
          } catch (e) {
            this.showNotification(e.message, 'error');
          }
        },
  
        // Проверить DNS (вызывает наш @action verify)
        async checkDns(id) {
          this.isChecking[id] = true;
          try {
            const res = await fetch(`${API_BASE}${id}/verify/`, {
              method: 'POST',
              credentials: 'same-origin',
              headers: { 'X-CSRFToken': getCSRFToken() }
            });
            if (!res.ok) throw new Error('Ошибка проверки DNS');
            const upd = await res.json();
            this.showNotification('DNS проверен');
            // обновляем локально
            const idx = this.domains.findIndex(d => d.id === id);
            if (idx !== -1) {
              this.domains[idx].spf      = upd.spf_verified;
              this.domains[idx].dkim     = upd.dkim_verified;
              this.domains[idx].verified = upd.is_verified;
            }
          } catch (e) {
            this.showNotification(e.message, 'error');
          } finally {
            this.isChecking[id] = false;
          }
        },
  
        // Копирование
        copyToClipboard(text) {
          navigator.clipboard.writeText(text);
          this.showNotification('Скопировано в буфер');
        },
  
        // Уведомления
        showNotification(message, type = 'success') {
          this.notification = { message, type };
          setTimeout(() => this.notification = null, 3000);
        }
      }));
    });
  
    // Обновляем Lucide иконки после каждого обновления DOM
    document.addEventListener('alpine:initialized', () => lucide.createIcons());
    document.addEventListener('alpine:updated',     () => lucide.createIcons());
  </script>
  